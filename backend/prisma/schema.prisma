// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum UserRole {
  ADMIN
  CONTADOR
  COLABORADOR
}

enum AnexoSimples {
  I
  II
  III
  IV
  V
}

enum CalculationStatus {
  DRAFT
  CALCULATED
  FINALIZED
}

enum BankAccountType {
  CHECKING
  SAVINGS
  PAYMENT
}

enum IntegrationProvider {
  PLUGGY
  BELVO
  HOTMART
  KIWIFY
  EDUZZ
}

model Organization {
  id              String             @id @default(uuid()) @db.Uuid
  cnpj            String             @unique @db.Char(14)
  razaoSocial     String             @map("razao_social") @db.VarChar(255)
  status          OrganizationStatus @default(ACTIVE) @map("status")
  deletedAt       DateTime?          @map("deleted_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  users            User[]
  bankAccounts     BankAccount[]
  bankTransactions BankTransaction[]
  integrations     Integration[]
  revenues         Revenue[]
  taxCalculations  TaxCalculation[]
  aiConversations  AIConversation[]
  auditLogs        AuditLog[]

  @@map("organizations")
}

model User {
  id             String         @id @default(uuid()) @db.Uuid
  organizationId String         @map("organization_id") @db.Uuid
  organization   Organization   @relation(fields: [organizationId], references: [id])
  email          String         @db.VarChar(255)
  passwordHash   String         @map("password_hash") @db.Text
  role           UserRole       @default(COLABORADOR)
  deletedAt      DateTime?      @map("deleted_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  
  refreshTokens  RefreshToken[]
  aiConversations AIConversation[]
  auditLogs      AuditLog[]

  @@unique([email, organizationId])
  @@map("users")
}

model RefreshToken {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash          String    @unique @map("token_hash") @db.Text
  expiresAt          DateTime  @map("expires_at")
  isRevoked          Boolean   @default(false) @map("is_revoked")
  replacedByTokenId  String?   @map("replaced_by_token_id") @db.Uuid
  userAgent          String?   @map("user_agent") @db.Text
  ipAddress          String?   @map("ip_address") @db.Inet
  createdAt          DateTime  @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

model BankAccount {
  id             String          @id @default(uuid()) @db.Uuid
  organizationId String          @map("organization_id") @db.Uuid
  organization   Organization    @relation(fields: [organizationId], references: [id])
  providerId     String          @map("provider_id")
  accountName    String          @map("account_name")
  accountType    BankAccountType @map("account_type")
  balance        Decimal         @default(0) @db.Decimal(15, 2)
  deletedAt      DateTime?       @map("deleted_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  
  transactions   BankTransaction[]

  @@map("bank_accounts")
}

model BankTransaction {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id])
  bankAccountId  String       @map("bank_account_id") @db.Uuid
  bankAccount    BankAccount  @relation(fields: [bankAccountId], references: [id])
  externalId     String?      @unique @map("external_id")
  amount         Decimal      @db.Decimal(15, 2)
  description    String?      @db.Text
  occurredAt     DateTime     @map("occurred_at")
  createdAt      DateTime     @default(now()) @map("created_at")

  @@map("bank_transactions")
}

model Integration {
  id                  String              @id @default(uuid()) @db.Uuid
  organizationId      String              @map("organization_id") @db.Uuid
  organization        Organization        @relation(fields: [organizationId], references: [id])
  provider            IntegrationProvider
  credentialsVaultId  String              @map("credentials_vault_id")
  isActive            Boolean             @default(true) @map("is_active")
  lastSyncAt          DateTime?           @map("last_sync_at")
  createdAt           DateTime            @default(now()) @map("created_at")

  @@unique([organizationId, provider])
  @@map("integrations")
}

model MotorVersion {
  id              String           @id @default(uuid()) @db.Uuid
  versionTag      String           @unique @map("version_tag") @db.VarChar(50)
  config          Json
  createdAt       DateTime         @default(now()) @map("created_at")
  taxCalculations TaxCalculation[]

  @@map("motor_versions")
}

model Revenue {
  id             String               @id @default(uuid()) @db.Uuid
  organizationId String               @map("organization_id") @db.Uuid
  organization   Organization         @relation(fields: [organizationId], references: [id])
  competencia    String               @db.Char(7)
  amount         Decimal              @db.Decimal(15, 2)
  source         IntegrationProvider?
  occurredAt     DateTime             @map("occurred_at") @db.Date
  deletedAt      DateTime?            @map("deleted_at")
  createdAt      DateTime             @default(now()) @map("created_at")

  @@index([organizationId, occurredAt])
  @@map("revenues")
}

model TaxCalculation {
  id             String            @id @default(uuid()) @db.Uuid
  organizationId String            @map("organization_id") @db.Uuid
  organization   Organization      @relation(fields: [organizationId], references: [id])
  motorVersionId String            @map("motor_version_id") @db.Uuid
  motorVersion   MotorVersion      @relation(fields: [motorVersionId], references: [id])
  competencia    String            @db.Char(7)
  amountRbt12    Decimal           @map("amount_rbt12") @db.Decimal(15, 2)
  taxAmount      Decimal           @map("tax_amount") @db.Decimal(15, 2)
  status         CalculationStatus @default(DRAFT)
  createdAt      DateTime          @default(now()) @map("created_at")

  @@unique([organizationId, competencia])
  @@map("tax_calculations")
}

model AIConversation {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         String       @map("user_id") @db.Uuid
  user           User         @relation(fields: [userId], references: [id])
  title          String?
  createdAt      DateTime     @default(now()) @map("created_at")
  
  messages       AIMessage[]

  @@map("ai_conversations")
}

model AIMessage {
  id             String         @id @default(uuid()) @db.Uuid
  conversationId String         @map("conversation_id") @db.Uuid
  conversation   AIConversation @relation(fields: [conversationId], references: [id])
  role           String
  content        String         @db.Text
  // Prisma não suporta o tipo `vector` diretamente de forma nativa para queries de busca,
  // mas podemos definir o tipo no banco. Para o Prisma Client, lidamos como Unsupported.
  embedding      Unsupported("vector(1536)")?
  createdAt      DateTime       @default(now()) @map("created_at")

  @@map("ai_messages")
}

model AuditLog {
  id             BigInt       @id @default(autoincrement())
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         String?      @map("user_id") @db.Uuid
  user           User?        @relation(fields: [userId], references: [id])
  event          String
  oldData        Json?        @map("old_data")
  newData        Json?        @map("new_data")
  ipAddress      String?      @map("ip_address") @db.Inet
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([organizationId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ─── LGPD Compliance Models ─────────────────────

enum ConsentType {
  OPEN_FINANCE
  DATA_PROCESSING
  MARKETING
  THIRD_PARTY_SHARING
}

enum ConsentStatus {
  GRANTED
  REVOKED
}

enum ErasureStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model DataConsent {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  consentType    ConsentType   @map("consent_type")
  status         ConsentStatus @default(GRANTED)
  scope          Json          // Escopo detalhado dos dados consentidos
  ipAddress      String?       @map("ip_address") @db.Inet
  userAgent      String?       @map("user_agent") @db.Text
  grantedAt      DateTime      @default(now()) @map("granted_at")
  revokedAt      DateTime?     @map("revoked_at")
  expiresAt      DateTime?     @map("expires_at")

  @@index([organizationId, consentType])
  @@map("data_consents")
}

model RetentionPolicy {
  id             String   @id @default(uuid()) @db.Uuid
  dataCategory   String   @unique @map("data_category") @db.VarChar(100)
  retentionDays  Int      @map("retention_days")
  legalBasis     String   @map("legal_basis") @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("retention_policies")
}

model DataErasureRequest {
  id             String       @id @default(uuid()) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  requestedBy    String       @map("requested_by") @db.Uuid
  status         ErasureStatus @default(PENDING)
  scope          Json          // Quais dados incluir na exclusão
  completedAt    DateTime?    @map("completed_at")
  errorDetails   String?      @map("error_details") @db.Text
  integrityHash  String?      @map("integrity_hash") @db.Text
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([organizationId])
  @@map("data_erasure_requests")
}
